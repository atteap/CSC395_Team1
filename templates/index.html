<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Builder</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav>
        <div class="nav-bar">
            <a href="{{ url_for('index') }}" class="main">Team 1</a>
        </div>
    </nav>

    <div class="center">
        <select id="dropdown" aria-label="Select a company">
            <option value="none" selected>Select a company</option>
            {% for company in companies %}
                <option value="{{ company }}">{{ company }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div id="text-box">
        <p>You selected: <span id="selected-option">Select a company</span></p>
        <textarea id="text-input" rows="4" cols="50" placeholder="List your ingredients here..."></textarea>
        <br>
        <button id="submit-btn" disabled>SUBMIT</button>
    </div>

    <div id="loading" style="display:none;">Loading...</div>

    <div id="message-box"></div>

    <div>
        <img src="{{ url_for('static', filename='dino.png') }}" alt="Dinosaur Image" role="presentation" class="overlay-image">
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        document.getElementById('dropdown').addEventListener('change', function() {
            const selectedCompany = this.value;
            const textInput = document.getElementById('text-input').value.trim();
            document.getElementById('selected-option').innerText = selectedCompany;
            document.getElementById('submit-btn').disabled = selectedCompany === "none" || textInput === "";
        });

        document.getElementById('text-input').addEventListener('input', function() {
            const selectedCompany = document.getElementById('dropdown').value;
            document.getElementById('submit-btn').disabled = selectedCompany === "none" || this.value.trim() === "";
        });

        document.getElementById('submit-btn').addEventListener('click', function() {
            const company = document.getElementById('dropdown').value;
            const ingredients = document.getElementById('text-input').value.trim();

            if (company !== "none" && ingredients) { // Check inputs
                const dataToSend = {
                    company: company,
                    ingredients: ingredients
                };

                // Display loading indicator
                document.getElementById('loading').style.display = 'block';

                // Send data to the /submit endpoint
                fetch('/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataToSend)
                })
                .then(async response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.statusText);
                    }

                    // Process the response as a stream
                    const reader = response.body.getReader();
                    let chunks = '';
                    let done = false;

                    while (!done) {
                        const { value, done: readerDone } = await reader.read();
                        if (value) {
                            chunks += new TextDecoder().decode(value); // Append decoded chunks
                        }
                        done = readerDone;
                    }

                    // Parse the full concatenated response
                    const data = JSON.parse(chunks);

                    // Display the received data
                    document.getElementById('message-box').innerHTML = `
                        <h2>Recipe Name: ${data.name}</h2>
                        <h4>Tagline: ${data.tagline}</h4>
                        <h3>Ingredients:</h3>
                        <ul>${data.ingredients.map(item => `<li>${item}</li>`).join('')}</ul>
                        <h3>Instructions:</h3>
                        <p>${data.instructions}</p>
                    `;

                    document.getElementById('loading').style.display = 'none'; // Hide loading indicator
                })
                .catch(error => {
                    console.error('Error sending data to the server:', error);
                    document.getElementById('message-box').innerText = 'Error: ' + error.message;
                    document.getElementById('loading').style.display = 'none'; // Hide loading indicator
                });
            }
        });
    </script>
</body>
</html>
